
---
title: "Data Quality Checks Across Datasets"
author: "2555479 Munyaradzi Ndumeya"
date: "2025-08-27"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results = 'hold')
set.seed(1996)
```

# 0) Packages

```{r libraries}
library(GEOquery)
library(caret)
library(dplyr)
library(ggplot2)
library(reshape2)
library(tibble)
library(gridExtra)
library(pheatmap)
library(RColorBrewer)
library(stats)
```

# 1) Loading and Labelling Datasets

```{r load_datasets}
load_GEO_dataset <- function(gse_id) {
  cat("\n--- Loading dataset:", gse_id, "---\n")
  gse <- getGEO(gse_id, GSEMatrix = TRUE)[[1]]
  expr <- exprs(gse)   
  pheno <- pData(gse)  
  stopifnot(colnames(expr) == rownames(pheno))
  
  # Label extraction
  tissue_col <- grep("tissue|characteristics|source|description", 
                     colnames(pheno), ignore.case = TRUE, value = TRUE)[1]
  labels <- ifelse(grepl("tumor|cancer|malignant", pheno[, tissue_col], ignore.case = TRUE), "Tumor",
                   ifelse(grepl("normal|control|healthy", pheno[, tissue_col], ignore.case = TRUE), "Normal", NA))
  labels <- factor(labels, levels = c("Normal", "Tumor"))
  
  list(expr = expr, pheno = pheno, labels = labels)
}

datasets <- list(
  Lung   = "GSE19804",
  Breast = "GSE15852",
  Liver  = "GSE112790",
  Gastric= "GSE13911"
)

loaded_data <- lapply(datasets, load_GEO_dataset)
```

 
#******************          2.Data Quality Checks         *********************

#  2.a Dimensions & Class Distribution

```{r qc_dimensions}
for (nm in names(loaded_data)) {
  cat("\n### Dataset:", nm, "###\n")
  X <- loaded_data[[nm]]$expr
  y <- loaded_data[[nm]]$labels
  cat("Number of samples:", ncol(X), "\n")
  cat("Number of features:", nrow(X), "\n")
  cat("Class distribution:\n")
  print(table(y))
}
```


#  2.b Missingness

```{r qc_missing}
for (nm in names(loaded_data)) {
  X <- loaded_data[[nm]]$expr
  cat("\n### Dataset:", nm, "###\n")
  cat("Total missing values:", sum(is.na(X)), "\n")
  
  missing_per_gene <- rowMeans(is.na(X))
  cat("Genes with >10% missing:", sum(missing_per_gene > 0.1), "\n")
  
  missing_per_sample <- colMeans(is.na(X))
  cat("Samples with >10% missing:", sum(missing_per_sample > 0.1), "\n")
}
```


# 2.c Feature Variance

```{r qc_variance}
for (nm in names(loaded_data)) {
  X <- t(loaded_data[[nm]]$expr)
  vars <- apply(X, 2, var)
  cat("\n### Dataset:", nm, "###\n")
  cat("Min variance:", min(vars), "\n")
  cat("Max variance:", max(vars), "\n")
  cat("Median variance:", median(vars), "\n")
}
```


## 2.d Duplicate Samples

```{r qc_duplicates}
for (nm in names(loaded_data)) {
  X <- t(loaded_data[[nm]]$expr)
  duplicates <- sum(duplicated(X))
  cat("\n### Dataset:", nm, "###\n")
  cat("Number of duplicate samples:", duplicates, "\n")
}
```


## 2.e Outlier Detection and Class separation(PCA)

```{r qc_outliers_pca}
for (nm in names(loaded_data)) {
  X <- t(loaded_data[[nm]]$expr)
  pca <- prcomp(X, scale. = TRUE)
  scores <- pca$x[,1:2]
  y <- loaded_data[[nm]]$labels
  df <- data.frame(PC1 = scores[,1], PC2 = scores[,2], Class = y)
  
  p <- ggplot(df, aes(x = PC1, y = PC2, color = Class)) +
       geom_point(size = 3) +
       ggtitle(paste("PCA —", nm, "(Outlier Detection)")) +
       theme_minimal()
  print(p)
}
```


## 2.f Hierarchical Clustering (optional outlier check)

```{r qc_hclust}
for (nm in names(loaded_data)) {
  X <- t(loaded_data[[nm]]$expr)
  dist_mat <- dist(X)
  hc <- hclust(dist_mat)
  plot(hc, main = paste("Hierarchical Clustering —", nm))
}
```


## 2.g Check Class Balance

```{r qc_class_balance}
for (nm in names(loaded_data)) {
  y <- loaded_data[[nm]]$labels
  df <- data.frame(Class = y)
  p <- ggplot(df, aes(x = Class)) +
       geom_bar(fill = "darkorange") +
       ggtitle(paste("Raw Class Distribution —", nm)) +
       theme_minimal()
  print(p)
}
```


## 2.e Data Consistency Checks

```{r qc_consistency}
for (nm in names(loaded_data)) {
  X <- loaded_data[[nm]]$expr
  y <- loaded_data[[nm]]$labels
  stopifnot(length(y) == ncol(X)) # Samples match labels
  stopifnot(all(!is.na(y)))       # No missing labels
}
cat("\nAll datasets passed consistency checks.\n")
```


## 2.f Optional Microarray QC Checks

#* Checking for extreme outliers in expression values.
#* Visualising distributions across samples using boxplots or density plots.

```{r qc_boxplots}
library(reshape2)

for (nm in names(loaded_data)) {
  X <- loaded_data[[nm]]$expr
  df <- as.data.frame(X)
  df_melt <- melt(df, variable.name = "Sample", value.name = "Expression")
  
  p <- ggplot(df_melt, aes(x = Sample, y = Expression)) +
       geom_boxplot(outlier.size = 0.5) +
       ggtitle(paste("Expression Distribution —", nm)) +
       xlab("Samples") + ylab("Expression") +
       theme(axis.text.x = element_blank())
  
  print(p)
}
```
